# AWS 手作業構築手順書

github-analyzer を AWS 上で動作させるための手順書。

---

## 構成図

```
┌─────────────────────────────────────────────────────────┐
│                         VPC                              │
│                                                          │
│   ┌────────────────────────┐  ┌─────────────────────┐   │
│   │    Public Subnet       │  │   Private Subnet    │   │
│   │                        │  │                     │   │
│   │  ┌─────┐   ┌───────┐  │  │    ┌───────────┐    │   │
│   │  │ ALB │──▶│  ECS  │──┼──┼───▶│    RDS    │    │   │
│   │  └─────┘   │Fargate│  │  │    │ PostgreSQL│    │   │
│   │            └───┬───┘  │  │    └───────────┘    │   │
│   │                │      │  │                     │   │
│   └────────────────┼──────┘  └─────────────────────┘   │
│                    │                                     │
│              Internet Gateway                            │
│                    │                                     │
│                    ▼                                     │
│            Gemini API / GitHub API                       │
└─────────────────────────────────────────────────────────┘
```

---

## 前提条件

| ツール | 確認コマンド |
|--------|------------|
| AWS CLI | `aws --version` |
| Docker | `docker --version` |
| AWS認証情報 | `aws sts get-caller-identity` |

---

## Step 1: VPC作成

```
AWSコンソール → VPC → 「VPCを作成」
```

| 項目 | 値 |
|------|-----|
| 作成するリソース | VPCなど |
| 名前タグ | `github-analyzer` |
| IPv4 CIDR | `10.0.0.0/16` |
| AZの数 | 2 |
| パブリックサブネット | 2 |
| プライベートサブネット | 2 |
| NAT ゲートウェイ | なし |
| VPCエンドポイント | なし |

以下が自動で作成される:
- VPC × 1
- Public Subnet × 2（AZ分散）
- Private Subnet × 2（AZ分散）
- Internet Gateway × 1
- ルートテーブル

---

## Step 2: セキュリティグループ作成

```
VPC → セキュリティグループ → 「セキュリティグループを作成」
```

3つ作成する。

### ALB用

| 項目 | 値 |
|------|-----|
| 名前 | `github-analyzer-alb-sg` |
| VPC | `github-analyzer-vpc` |
| インバウンド | HTTP(80) `0.0.0.0/0`、HTTPS(443) `0.0.0.0/0` |
| アウトバウンド | デフォルト（全許可） |

### ECS用

| 項目 | 値 |
|------|-----|
| 名前 | `github-analyzer-ecs-sg` |
| VPC | `github-analyzer-vpc` |
| インバウンド | カスタムTCP(8000) ソース: `github-analyzer-alb-sg` |
| アウトバウンド | デフォルト（全許可） |

### RDS用

| 項目 | 値 |
|------|-----|
| 名前 | `github-analyzer-rds-sg` |
| VPC | `github-analyzer-vpc` |
| インバウンド | PostgreSQL(5432) ソース: `github-analyzer-ecs-sg` |
| アウトバウンド | デフォルト（全許可） |

---

## Step 3: RDS作成

```
AWSコンソール → RDS → 「データベースの作成」
```

| 項目 | 値 |
|------|-----|
| 作成方法 | 標準作成 |
| エンジン | PostgreSQL |
| テンプレート | 無料利用枠 |
| DB識別子 | `github-analyzer-db` |
| マスターユーザー名 | `postgres` |
| マスターパスワード | 任意（メモしておく） |
| インスタンスクラス | `db.t3.micro` |
| ストレージ | 20GiB |
| ストレージ自動スケーリング | 無効 |
| VPC | `github-analyzer-vpc` |
| パブリックアクセス | なし |
| セキュリティグループ | `github-analyzer-rds-sg` |
| 初期データベース名 | `github_analyzer` |

> 起動まで5〜10分かかる。待ち時間でStep 4を進める。

作成後、エンドポイントをメモ:
```
github-analyzer-db.xxxxxxxxxx.ap-northeast-1.rds.amazonaws.com
```

---

## Step 4: ECRリポジトリ作成 → イメージpush

### リポジトリ作成

```
AWSコンソール → ECR → 「リポジトリを作成」
```

| 項目 | 値 |
|------|-----|
| 可視性 | プライベート |
| リポジトリ名 | `github-analyzer` |

### イメージpush（ローカルで実行）

```bash
# ECRログイン
aws ecr get-login-password --region ap-northeast-1 | \
  docker login --username AWS --password-stdin \
  <アカウントID>.dkr.ecr.ap-northeast-1.amazonaws.com

# ビルド
cd backend
docker build -t github-analyzer .

# タグ付け
docker tag github-analyzer:latest \
  <アカウントID>.dkr.ecr.ap-northeast-1.amazonaws.com/github-analyzer:latest

# push
docker push \
  <アカウントID>.dkr.ecr.ap-northeast-1.amazonaws.com/github-analyzer:latest
```

---

## Step 5: ECSクラスター作成

```
AWSコンソール → ECS → 「クラスターの作成」
```

| 項目 | 値 |
|------|-----|
| クラスター名 | `github-analyzer-cluster` |
| インフラ | AWS Fargate |

> 初回のみ、事前にサービスリンクロールの作成が必要:
> ```bash
> aws iam create-service-linked-role --aws-service-name ecs.amazonaws.com
> ```

---

## Step 6: タスク定義作成

```
ECS → タスク定義 → 「新しいタスク定義の作成」
```

### 基本設定

| 項目 | 値 |
|------|-----|
| ファミリー | `github-analyzer-task` |
| 起動タイプ | AWS Fargate |
| OS | Linux/X86_64 |
| CPU | 0.25 vCPU |
| メモリ | 0.5 GB |
| タスク実行ロール | デフォルト |

### コンテナ定義

| 項目 | 値 |
|------|-----|
| コンテナ名 | `github-analyzer` |
| イメージURI | `<アカウントID>.dkr.ecr.ap-northeast-1.amazonaws.com/github-analyzer:latest` |
| コンテナポート | 8000 |
| プロトコル | TCP |

### 環境変数

| キー | 値 |
|------|-----|
| `DATABASE_URL` | `postgresql://postgres:<パスワード>@<RDSエンドポイント>:5432/github_analyzer` |
| `GEMINI_API_KEY` | 自分のGemini APIキー |
| `GEMINI_MODEL` | 自分のGeminiのモデル |
| `GITHUB_CLIENT_ID` | 自分のGitHub OAuth Client ID |
| `GITHUB_CLIENT_SECRET` | 自分のGitHub OAuth Secret |
| `JWT_SECRET_KEY` | 任意の文字列 |

---

## Step 7: ALB作成

```
EC2 → ロードバランサー → 「ロードバランサーの作成」→ Application Load Balancer
```

| 項目 | 値 |
|------|-----|
| 名前 | `github-analyzer-alb` |
| スキーム | インターネット向け |
| VPC | `github-analyzer-vpc` |
| サブネット | Publicサブネット2つ |
| セキュリティグループ | `github-analyzer-alb-sg` |

> ⚠️ リスナーはこの時点では作成しない。ECSサービス作成時に紐付ける。

作成後、DNS名をメモ:
```
github-analyzer-alb-xxxxxxxxxx.ap-northeast-1.elb.amazonaws.com
```

---

## Step 8: ECSサービス作成

```
ECS → github-analyzer-cluster → サービス → 「作成」
```

### 基本設定

| 項目 | 値 |
|------|-----|
| コンピューティング | 起動タイプ → FARGATE |
| タスク定義 | `github-analyzer-task` |
| サービス名 | `github-analyzer-service` |
| タスク数 | 1 |

### ネットワーキング

| 項目 | 値 |
|------|-----|
| VPC | `github-analyzer-vpc` |
| サブネット | Publicサブネット2つ |
| セキュリティグループ | `github-analyzer-ecs-sg` |
| パブリックIP | オン |

### ロードバランシング

| 項目 | 値 |
|------|-----|
| タイプ | Application Load Balancer |
| ロードバランサー | 既存 → `github-analyzer-alb` |
| リスナー | 新規作成 → HTTP:80 |
| ターゲットグループ | 既存 → `github-analyzer-tg` |

---

## Step 9: GitHub OAuth設定

```
GitHub → Settings → Developer settings → OAuth Apps → 対象アプリ
```

| 項目 | 値 |
|------|-----|
| Homepage URL | `http://<ALBのDNS名>` |
| Authorization callback URL | `http://<ALBのDNS名>/auth/github/callback` |

---

## Step 10: 動作確認

| URL | 期待する結果 |
|-----|-------------|
| `http://<ALBのDNS名>` | `{"message":"github-analyzer API"}` |
| `http://<ALBのDNS名>/docs` | Swagger UI が表示される |

---

## 起動手順（面接前日）

```bash
# 1. RDS起動（AWSコンソール）
#    RDS → github-analyzer-db → アクション → 起動
#    起動まで5〜10分待つ

# 2. ECSタスクを起動
aws ecs update-service \
  --cluster github-analyzer-cluster \
  --service github-analyzer-service \
  --desired-count 1
```

---

## 停止手順（面接後）

```bash
# 1. ECSタスクを停止
aws ecs update-service \
  --cluster github-analyzer-cluster \
  --service github-analyzer-service \
  --desired-count 0

# 2. RDS停止（AWSコンソール）
#    RDS → github-analyzer-db → アクション → 停止
```

---

## 注意事項

- **ALB は停止できない**: 存在するだけで約$16/月の課金が発生する。完全にコストを0にしたい場合は CloudFormation での一括管理を推奨。
- **RDS は最大7日間しか停止できない**: 7日後に自動起動するため、定期的に再停止が必要。
- **イメージ更新時の再デプロイ**: コード変更後は以下を実行する。

```bash
# ビルド & push
docker build --no-cache -t github-analyzer .
docker tag github-analyzer:latest <アカウントID>.dkr.ecr.ap-northeast-1.amazonaws.com/github-analyzer:latest
docker push <アカウントID>.dkr.ecr.ap-northeast-1.amazonaws.com/github-analyzer:latest

# ECS再デプロイ
aws ecs update-service \
  --cluster github-analyzer-cluster \
  --service github-analyzer-service \
  --force-new-deployment
```